name: ğŸš€ Deploy the Mighty Rnt Social API ğŸš€

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ‰ Checkout the glorious code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21 (Because Java is life)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: ğŸ”¨ Build with Maven (with GitHub Token)
        run: mvn clean install -DskipTests

      - name: ğŸ” Find the executable JAR
        id: find-jar
        run: |
          # Find the Spring Boot repackaged JAR in the main application module
          JAR_FILE=$(find ./rnt-social-api-main/target -name "*.jar" ! -name "*sources*" ! -name "*javadoc*" ! -name "*.original" -exec ls -S {} + | head -n 1)
          echo "JAR_FILE_PATH=$JAR_FILE" >> $GITHUB_ENV
          echo "ğŸ” Found executable JAR: $JAR_FILE"

      - name: ğŸ” Verify JAR has manifest & Spring boot executable
        run: |
          # Find the main JAR in the main application module (excluding sources/javadoc/original)
          JAR_FILE=$(find ./rnt-social-api-main/target -name "*.jar" ! -name "*sources*" ! -name "*javadoc*" ! -name "*.original" | head -n 1)
          
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ Error: No JAR file found!"
            exit 1
          fi
          
          echo "JAR_FILE_PATH=$JAR_FILE" >> $GITHUB_ENV
          echo "ğŸ” Found JAR file: $JAR_FILE"
          
          # Verify it contains a manifest (using jar command instead of unzip)
          if ! jar tf "$JAR_FILE" | grep -q META-INF/MANIFEST.MF; then
            echo "âŒ Error: No manifest found in JAR!"
            echo "JAR contents:"
            jar tf "$JAR_FILE" | head -20
            exit 1
          fi
          
          # Additional verification for Spring Boot apps
          if ! jar tf "$JAR_FILE" | grep -q BOOT-INF/classes; then
            echo "âš ï¸ Warning: Not a Spring Boot executable JAR?"
          fi

      - name: ğŸ›  Install missing warriors (rsync and sshpass)
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync sshpass

      - name: ğŸ›¡ Fetch server host key (because security matters)
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          echo "ğŸ”‘ Trust established with ${{ secrets.SERVER_IP }}"

      - name: ğŸš€ Deploy with Real Rsync Progress
        run: |
          echo "ğŸ”¥ Deploying $(basename ${JAR_FILE_PATH}) (Size: $(du -h ${JAR_FILE_PATH} | cut -f1))"
          
          # Rsync with proper progress reporting
          sshpass -p "${{ secrets.SSH_PASSWORD }}" \
            rsync -avz --info=progress2 --compress-level=9 --human-readable \
            -e "ssh -p ${{ secrets.SSH_PORT }}" \
            ${JAR_FILE_PATH} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/root/build/rnt_social_api.jar
          
          echo "âœ… Deployment complete!"
          echo "ğŸ”„ Verifying remote file..."
          
          # Get transfer verification
          sshpass -p "${{ secrets.SSH_PASSWORD }}" \
            ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "ls -lh /root/build/rnt_social_api.jar && \
             echo 'Checksum: '$(md5sum /root/build/rnt_social_api.jar | cut -d' ' -f1)"

      - name: ğŸ§ Verify JAR on server (Because trust issues)
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ•µï¸ Checking if the JAR survived the journey..."
            echo "JAR file size on server: $(du -h /root/build/rnt_social_api.jar)"
            echo "JAR file contents preview:"
            jar tf /root/build/rnt_social_api.jar | head -n 10
            echo "âœ… JAR looks good!"

      - name: ğŸ”“ Set file permissions (Because Linux likes control)
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ”§ Adjusting permissions for rnt_social_api.jar"
            sudo chmod 644 /root/build/rnt_social_api.jar
            sudo chown root:root /root/build/rnt_social_api.jar
            echo "âœ… Permissions updated!"

      - name: ğŸ”„ Restart Rnt Social API (Brace yourself...)
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ’€ Killing the old process..."
            sudo systemctl daemon-reload
            sudo systemctl restart rnt-social-api
            echo "ğŸš€ The new rnt-social-api is rising from the ashes!"
            sudo systemctl status rnt-social-api --no-pager
            echo "ğŸ‰ API is ALIVE! Time to celebrate! ğŸ‰"

      - name: ğŸ–¼ï¸ Pre-deployment Meme Motivation (Optional but fun)
        run: |
          echo "ğŸ”´ STOP! Before we continue, take a deep breath."
          echo "Here's some motivation for you: https://i.imgur.com/ZF7YhIj.jpg"
          echo "Now, let's ship it! ğŸš€"

#      - name: ğŸ¥³ Send Slack Notification on Success
#        if: success()
#        uses: rtCamp/action-slack-notify@v2.3.2
#        env:
#          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
#          SLACK_CHANNEL: "#deployments"
#          SLACK_USERNAME: "GitHub Actions"
#          SLACK_MESSAGE: |
#            ğŸ‰ *Rnt Social API Deployment: SUCCESS!* ğŸš€
#            âœ… *Everything went smoothly! Time to grab a coffee! â˜•*
#            *Repository:* ${{ github.repository }}
#            *Branch:* ${{ github.ref_name }}
#            *Commit:* `${{ github.sha }}`
#            *Deployed by:* ${{ github.actor }}
#            *Server:* `${{ secrets.SERVER_IP }}`
#            ğŸ•º *Now do a little dance to celebrate!*
#            https://giphy.com/gifs/party-dance-dancing-xT9Igo6YzPZSdTqdVu
#          SLACK_COLOR: "good"

#      - name: ğŸ¤¬ Send Slack Notification on Failure
#        if: failure()
#        uses: rtCamp/action-slack-notify@v2.3.2
#        env:
#          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
#          SLACK_CHANNEL: "#deployments"
#          SLACK_USERNAME: "GitHub Actions"
#          SLACK_MESSAGE: |
#            ğŸ˜¡ *Deployment Failed!* ğŸš¨
#            âŒ Something went horribly wrong!
#            *Repository:* ${{ github.repository }}
#            *Branch:* ${{ github.ref_name }}
#            *Commit:* `${{ github.sha }}`
#            *Blame:* ${{ github.actor }} (jk... or maybe not ğŸ¤”)
#            *Server:* `${{ secrets.SERVER_IP }}`
#            ğŸš‘ *Check logs in GitHub Actions!*
#            https://giphy.com/gifs/disaster-explosion-fire-3o7TKU8RvQuomFfUUU
#          SLACK_COLOR: "danger"

      - name: ğŸ’ƒ Celebrate (Only if successful)
        if: success()
        run: |
          echo "ğŸŠğŸ‰ Deployment was a success! Time for a victory dance! ğŸ•ºğŸ’ƒ"
          echo "https://giphy.com/gifs/party-dance-dancing-xT9Igo6YzPZSdTqdVu"